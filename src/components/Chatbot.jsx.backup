import { useEffect, useRef, useState } from "react";
import axios from "axios";

function ChatBubble({ role, children }) {
  const isBot = role === "bot";
  return (
    <div className={`flex ${isBot ? "justify-start" : "justify-end"}`}>
      <div
        className={`max-w-[75%] rounded-2xl px-3 py-2 text-sm shadow ${
          isBot ? "bg-gray-100 text-gray-800" : "bg-indigo-600 text-white"
        }`}
      >
        {children}
      </div>
    </div>
  );
}

function Chatbot() {
  const [open, setOpen] = useState(false);
  const [messages, setMessages] = useState([]);
  const [step, setStep] = useState(0);
  const [careerGoal, setCareerGoal] = useState("");
  const [answers, setAnswers] = useState({ python: null, viz: null });
  const [input, setInput] = useState("");
  const viewRef = useRef(null);

  // Auto-scroll chat to bottom when messages change
  useEffect(() => {
    if (viewRef.current) {
      viewRef.current.scrollTop = viewRef.current.scrollHeight;
    }
  }, [messages, open]);

  // On open, start conversation
  useEffect(() => {
    if (open && messages.length === 0) {
      // Optional delay for realism
      setTimeout(() => {
        setMessages([
          { role: "bot", text: "Hi there! üëã What‚Äôs your career goal?" },
        ]);
        setStep(1);
      }, 200);
    }
  }, [open]);

  function sendUser(text) {
    setMessages((prev) => [...prev, { role: "user", text }]);
  }

  function sendBot(text) {
    setTimeout(() => {
      setMessages((prev) => [...prev, { role: "bot", text }]);
    }, 300);
  }

  function sendToGemini(message) {
    return axios
      .post("https://api.gemini.com/chat", {
        message,
      })
      .then((response) => response.data.reply);
  }

  function handleSubmit(e) {
    e.preventDefault();
    const value = input.trim();
    if (!value) return;

    sendUser(value);
    setInput("");

    sendToGemini(value)
      .then((reply) => {
        sendBot(reply);
      })
      .catch((error) => {
        console.error("Error communicating with Gemini API:", error);
        sendBot("Sorry, I encountered an issue. Please try again later.");
      });
  }

  function handleYesNo(field, yes) {
    if (step === 2 && field === "python") {
      setAnswers((a) => ({ ...a, python: yes }));
      sendUser(yes ? "Yes" : "No");
      sendBot(
        "Are you familiar with data visualization tools (Matplotlib / Power BI)?"
      );
      setStep(3);
      return;
    }
    if (step === 3 && field === "viz") {
      setAnswers((a) => ({ ...a, viz: yes }));
      sendUser(yes ? "Yes" : "No");

      // Step 4: mock plan
      const plan = buildPlan(careerGoal, yes);
      sendBot(plan);
      setStep(4);
      return;
    }
  }

  function buildPlan(goal) {
    // This is where a real recommender/LLM would generate a path
    // based on user profile and survey results
    const base = `Your personalized plan for "${
      goal || "your goal"
    }":\n1Ô∏è‚É£ Learn Python Fundamentals\n2Ô∏è‚É£ Explore Data Visualization\n3Ô∏è‚É£ Master Machine Learning\n4Ô∏è‚É£ Build a Capstone Project`;
    // Simple tailoring based on answers
    const parts = [];
    if (answers.python === false)
      parts.push(
        "Start with an introductory Python course to cover basics quickly."
      );
    if (answers.viz === false)
      parts.push(
        "Add a short module on Matplotlib or Power BI to visualize data effectively."
      );
    const tail = parts.length ? `\n\nNotes:\n- ${parts.join("\n- ")}` : "";
    return base + tail;
  }

  function resetChat() {
    setMessages([]);
    setStep(0);
    setCareerGoal("");
    setAnswers({ python: null, viz: null });
    setInput("");
  }

  return (
    <>
      {open && (
        <div className="fixed bottom-24 right-4 w-80 max-w-[90vw] bg-white border shadow-xl rounded-lg overflow-hidden">
          <div className="px-4 py-2 border-b bg-gray-50 flex items-center justify-between">
            <span className="text-sm font-medium">
              AI Learning Assistant ü§ñ
            </span>
            <div className="flex items-center gap-2">
              {step === 4 && (
                <button
                  className="text-xs text-indigo-600 hover:underline"
                  onClick={resetChat}
                >
                  Restart
                </button>
              )}
              <button
                className="text-gray-500 hover:text-gray-700"
                onClick={() => setOpen(false)}
              >
                ‚úï
              </button>
            </div>
          </div>
          <div ref={viewRef} className="p-3 space-y-2 max-h-80 overflow-auto">
            {messages.map((m, idx) => (
              <ChatBubble key={idx} role={m.role}>
                {m.text}
              </ChatBubble>
            ))}

            {/* Controls per step */}
            {step === 1 && (
              <div className="text-xs text-gray-500">
                Please type your career goal and press Enter.
              </div>
            )}
            {step === 2 && (
              <div className="flex gap-2">
                <button
                  onClick={() => handleYesNo("python", true)}
                  className="rounded-md border px-3 py-1 text-sm hover:bg-gray-50"
                >
                  Yes
                </button>
                <button
                  onClick={() => handleYesNo("python", false)}
                  className="rounded-md border px-3 py-1 text-sm hover:bg-gray-50"
                >
                  No
                </button>
              </div>
            )}
            {step === 3 && (
              <div className="flex gap-2">
                <button
                  onClick={() => handleYesNo("viz", true)}
                  className="rounded-md border px-3 py-1 text-sm hover:bg-gray-50"
                >
                  Yes
                </button>
                <button
                  onClick={() => handleYesNo("viz", false)}
                  className="rounded-md border px-3 py-1 text-sm hover:bg-gray-50"
                >
                  No
                </button>
              </div>
            )}
          </div>
          <form onSubmit={handleSubmit} className="p-3 border-t">
            <input
              value={input}
              onChange={(e) => setInput(e.target.value)}
              className="w-full rounded-md border-gray-300 text-sm focus:border-indigo-500 focus:ring-indigo-500"
              placeholder={
                step <= 1
                  ? "Type your goal, e.g., Data Scientist"
                  : "You can also type a reply..."
              }
            />
          </form>
        </div>
      )}
      <button
        type="button"
        className="fixed bottom-6 right-6 h-12 w-12 rounded-full bg-indigo-600 text-white shadow-lg hover:bg-indigo-700"
        onClick={() => setOpen(!open)}
        aria-label="Open assistant"
      >
        üí¨
      </button>
    </>
  );
}

export default Chatbot;
